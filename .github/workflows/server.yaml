name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtGdWFXMWxZV3h3YUdFd01EUWlMQ0pTUlZCUElqb2lZVzVwYldVaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZMU5qWTJMQ0pKUkNJNklqY3lhbXc0VGtkUlluSnlUMlJuUzJrM1UwRldJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZUW5sYVdFNXNaRU5DZW1KSE9UTkpRekUwVFdwWk1VeFlRbWhqYlVaMFkzbEJibUpIT1haaE1rWnZXbGRHYTB4WVRuTmhWMDVzWTNvd01VOXVTbXBNVjNoMllqSjBhR0ZIVm1oYVJEQXdUVVJ3YVZwdVNtaGlWMVo2VUZSbk5tSlhWVGxqTTFKb1kycHdhR05UTVhSaU1sSnNVRlJOTm1OdFZtMVFWRmsyWTBoT05VeFlTbXRRVkVVMldWaEZkR016VW5sYVZ6VnVaRWRuT1UxRE5EUktlVUYwV20xc2MyUkhWbmxZTWs1MllsaENjMXBZWjJkS01qRjJaRzFzYkZCWVpHaGtSMVo1WWxkR2VXRXhPWFJpTTFwd1dsaE5kV05ITlc1SlJuUXpXVmhTYkdOdE1XaGpiWFJrVHpGemQxaFlUbXBaVjNoc1VGUnJNazFFYjNSTlZGbG5WekpzZFZoVWRHSmhWelZrVnpOa2FHUkhWbmxpVjBaNVlURXdaMkl6V214amJYaG9aVlF3ZVU5cVNXNUpRekZxWTIxWlowMXFWV2RNV0VKd1pVWTViV0pZVVdkbFdGWXlUa1JKZDJORFFqSmhWMUpzWW5reGNtVXpUbXhhTWpGc1ltNVJOazFFVG10bVV6VjBZVE5aYVZoVGQybFpNamwwV1cxc2RWcFRTVFpYZVVwdFdtMHhkMXBYWTJkTVdHdG5URmMxZG1NelVtdGhWelJuVEZkb2NGcEhWbVpaYlVaMVltMVdlVWxETVhWaU0wNHdXVmhTZWtsRE1YTmlNbVJ6V2xoYWJHSkRRbXhqYmtwMlkybEJkRnBwUW1waU1qVnFXVmhSWjB4WGEyZGpNbFp1WWxkV2RXUklUWFZhYlZwcVdWaFJaMHhYVFdkWk1qbDNaVk5DTW1GWFVteGllVEZ5VEcweGNtUnBTWE5KYlZwdFlsaENiRnA1UVhSbFUwRjBZbTA1ZW1SSFVuQmlhVUYwWVVkc2ExcFdPV2xaVnpWMVdsaEpaMHhYTlhaak0xSm9aRWhOWjB4WGVIWmFNbmhzWkcxV2MwbEhWbmxqYlRsNVNVTXhjRWxJZEcxaFYzaHNabE5CZEdKWFJuZEpSRUUyV1ZSdmQxQjVRWFJrYlRSblRGZE5ObGxUUW5OaFYwcDJZMGhXZWtsRE1XaFplVUY1U1VNeGFVOXRSV2RQVkZweVNVZEdNVnBIYkhaTWJURnlXVk5KYzBsdFdtMWlXRUpzV25sQmRHVlRRWFJpYlRsNlpFZFNjR0pwUVhSaFIyeHJXbFk1YVZsWE5YVmFXRWxuVEZjMWRtTXpVbWhrU0UxblRGZDRkbG95ZUd4a2JWWnpTVWRXZVdOdE9YbEpRekZ3U1VoYWNGcEhWblpNVjNOMVlsZDBNa2xETVhCSlIwWXhXa2RzZGt4dE1YSlpVMEYwWVZOQ04xcHRiSE5hV0RCblRGY3hhR05EUVhkUGJsbG5URmN4YUdORFFYaFBiVVZuVEZjeGFHTkRRWGxQYmswdlNVTXhhazl0UldkWk1qbDNaVk5CZEZsNmNESkpSMDUyWTBocloweFhUVFpqZVVKcVlqTkNOVWxEWkhSaU0xcHdXbGhOWjJJeU1YQlpNMHAyWW1reFRsbFlTbmxsVTBKS1kzbENTVmxZUW5kbFUwSk9XVmhLZVdWVFFrcGplVUpKV1ZoQ2QyVlROWFJoTTFsdVNXbDNhVnB0V25SalIxWnVTVU14TlVsRE1YVmlNMDR3V2tkc2RVbERNVzloVjFKc1dESkthR0p0Tld4amFVRjBZbTA1ZW1SSFJqQmplVUYwWWtjNWJtSkhWakphVjNkbldsaEtlV0l6U1dkTVYydG5Takl4ZG1SdGJHeGplVUoyWWxkc2FtTnRPWFZNVlRGb1kyNUtOVWxGYkhwSlJXaG9ZMGhDTlVsRk1XaGpia28xU1VWc2VrbEZhR2hqU0VJMVRHMHhjbVJwWTJkTVdFNTZTVVJCZDA5cVFYZFBha0Y0VEdwQmQwMURRWFJrYlZwNVdWY3hiR041UVhoSlF6RjZTVVJOZVUxSVozcE5ha0ZuU2pOU2IyUlhNV2xNYlhCM1dsZGpia2xwZDJsYWJWcDBZMGRXYmtsRE1UVkpRekYxWWpOT01GcEhiSFZKUXpGdllWZFNiRmd5U21oaWJUVnNZMmxCZEdKdE9YcGtSMFl3WTNsQmRHSkhPVzVpUjFZeVdsZDNaMXBZU25saU0wbG5URmRyWjBveU1YWmtiV3hzWTNsQ2RtSlhiR3BqYlRsMVRGVXhhR051U2pWSlJXeDZTVVZvYUdOSVFqVkpSVEZvWTI1S05VbEZiSHBKUldob1kwaENOVXh0TVhKa2FXTm5URmhPZWtsRVFYZFBha0Y2VDJwQmQweHFRWGROUTBGMFpHMWFlVmxYTVd4amVVRjRTVU14ZWtsRVRYbE5TR2Q2VFdwQlowb3pVbTlrVnpGcFRHMXdkMXBYWTI1SmJERTVURU5LZG1SWVVuZGtXRko2U1dwd1ltVjVTbTFoVjNoc1NXcHZhV0pYT1RKaFYxWjZTVWM1ZEdGWFRubGlNalIwVkZkR2VXTnVhMmRUV0UxblUwZEdkMk5JYTJkVVYwWjVZMjVyWjFOWVRXZFRSMFozWTBocmRXSlhkREpKYVhkcFpFZG9NV0pYU1dsUGFVb3dZVWhXZEZscE5YRmpSMVp1U1dsM2FXSkhSblZhZVVrMlNXMVdkVnA1U2psWVdEQTlJbjA9
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
