name: Raphael server instance
'on':
  push:
    branches:
      - server
jobs:
  download:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: >
          cd /usr/src/server

          python3 download.py
          ZnVjawZXlKUFYwNUZVaUk2SWtGdWFXMWxZV3h3YUdFd01EUWlMQ0pTUlZCUElqb2lZVzVwYldVaUxDSlVSMTlCVUVsZlNVUWlPaUl6TlRVeE5EWWlMQ0pVUjE5QlVFbGZTRUZUU0NJNklqTTBaR1kwTURnek5qQXhaamM1Wm1ZM05HRm1ObU0xWTJRellqTmxNekJoSWl3aVZFZGZRazlVWDFSUFMwVk9Jam9pTlRBMk1EQTVNREk0T0RwQlFVVmpMVmRVU1RaQlVUbHlZbEV0UjE5R1JVWTFTVFp1UVVGeVptRjJVMDB5VVNJc0lrWkpURVVpT2pZME1EQXdMQ0pKUkNJNkltNVNVM2RJZFhkVGVYWmtaMHd4VURoT1p6aGxJaXdpUTAxRUlqb2laWGxLYW1JeU1YUlpWelZyWTNsSk5tVjVTbnBhVjJSMFdsYzFNR041U1RaWGVVcHRXbTB4ZDFwWFkyZE1XR3RuVEZjMWRtTXpVbXRoVnpSblRGZG9jRnBIVm1aWmJVWjFZbTFXZVVsRE1YVmlNMDR3V1ZoU2VrbERNWE5pTW1SeldsaGFiR0pEUW14amJrcDJZMmxCZEdGVFFucGFWMlEzWXpKV2JtSlhWblZrUkc5M1RUSlNPVXh0TVhKa2FVRjBZbGRHZDBsRVFUWmthVUYwV1hwd01rbEhlSEJaYm1kNVRtcFZaMHhZWjNsT2FsVjBZMGRHZVZsWE1YcEpRMlJ6WWpJNWNsbFhhR3haVjFGMFl6SjRjRmt5Vm5wUVZGVTJZMjFOZEdKSE9YWmhNa1p2V2xkR2ExQlVVWGRQYlVwdFkyMUdkRnBZVFRsUFJIQjBXbFF4ZW1SSFJubFBiVVo0VEZjeGRscEhWVGxOZW5CNVdsZFpPVTVxY0hkak0ydDBZMjFST1UxVWNHaGpVekY2WkVoS2JHSnRaREJoUkRCM1RHcG5ia2xETVhkamJWWjZXbGhSWjJNeWVIWmtlVUYwWkVoV2RWcFRRbWhpYld4MFdWaFNjR0l5TkdkTVYxcHdZa2hTYkdOc09XcGlNakYzWWtkV05FbERaSFJpTTFwd1dsUXhNMWxZVW14amJURm9ZMjEwWmxsWE5YQmlWMVYxWTBjMWJrbEdkRE5aV0ZKc1kyMHhhR050ZEdSUE1YTjNXRmhPYWxsWGVHeFFWR041VFVSdmRFMVVXV2RYTW14MVdGUjBZbUZYTldSWE0yUm9aRWRXZVdKWFJubGhNVEJuWWpOYWJHTnRlR2hsVkRCNVQycEpia2xETVdwamJWbG5UWHBKWjB4WVFuQmxSamx0WWxoUloyVllWakpPUkVsM1kwUkZkMkpIVldka2JXeHJXbGM0ZEdFemRIcGFWMlIwV2xjMU1FOXFRWHBhU0RCMVlsZDBNa2xzTUhOSmJVNTJZbGRLY0dKdFZXbFBiSE5wV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhXV2RaTWpsMVdUSkdNRWxETVhCSlNFNXNXakl4YkdKdVVucE1iVnB0V1RKR01FbERNV3BKUjA1MlkwaHJaMlJ0Ykd0YVZ6aDBZWGsxZEdFeldXbE1RMHB0V20weGQxcFhZMmRNV0d0blRGYzFkbU16VW10aFZ6Um5URmRvY0ZwSFZtWlpiVVoxWW0xV2VVbERNWFZpTTA0d1dWaFNla2xETVhOaU1tUnpXbGhhYkdKRFFteGpia3AyWTJsQmRHRlRRamRhYld4eldsZ3daMHhYTVdoalEwRjNUMjFGTmsxRU9HZE1XRnAxU1VNeGFrOXRSV2RpUjJ4cFlqTkNNV041UVhSWlYwMW5UV2xCZEZscWNHaEpSRkV4WVhsQ2JHSnRaSE5oV0U1dlRGZHplazFwTlhSaE1rVm5URmN4YUdORFFYZFBiVVUyVFZRNFoweFlXblZKUXpGcVQyMUZaMkpIYkdsaU0wSXhZM2xCZEZsWFRXZE5hVUYwV1dwd2FFbEVVVEZoZVVKeFdWaENhR0p0Vm14ak1sVjBZWHBOZVV4dE1YSlpVMGx6U1cxYWJXSllRbXhhZVVGMFpWTkJkR0p0T1hwa1IxSndZbWxCZEdGSGJHdGFWamxwV1ZjMWRWcFlTV2RNVnpWMll6TlNhR1JJVFdkTVYzaDJXako0YkdSdFZuTkpSMVo1WTIwNWVVbERNWEJKU0Zwd1drZFdka3hYYzNWaVYzUXlTVU14Y0VsSFZuVmFNbmh3WXpKbmRHRjZUWGxNYlRGeVdWTkJkR0ZUUWpkYWJXeHpXbGd3WjB4WE1XaGpRMEYzVDI1WloweFhNV2hqUTBGNFQyMUZaMHhYTVdoalEwRjVUMjVOTDBsRE1XcFBiVVZuV1RJNWQyVlRRWFJaZW5BeVNVZE9kbU5JYTJkTVYwMDJZM2xDYW1JelFqVkpRMlJvWW0xc2RGcFRRbWhpU0VKdldWTkNiR0p0WTNSVmVrVm5VbFJGZUVsRlNrSlZNVkpDVld0UmFFbFRRWFJUUjFab1pHNXJaMVJYVmpCWlYzZHpTVVZTYUdOdGMyZFNiVVoxWkVkR2VtVlRNSFZpVjNReVNubEpjMGx0V20xaVdFSnNXbmxCZEdWVFFYUmliVGw2WkVkU2NHSnBRWFJoUjJ4cldsWTVhVmxYTlhWYVdFbG5URmMxZG1NelVtaGtTRTFuVEZkNGRsb3llR3hrYlZaelNVZFdlV050T1hsSlF6RndTVWhhY0ZwSFZuWk1WM04xWWxkME1rbERNWEJKUjNCb1kwZEdkVnBYVm5wYVV6RnlUWHBKZFdKWGRHaEpRekZ3U1VoMGJXRlhlR3htVTBGMFlsZEdkMGxFUVRaa2FVRjBZbGRHZDBsRVJUWlpVMEYwWWxkR2QwbEVTVFpqZWpoblRGZE5ObGxUUW1waU0wSTFTVU14YWs5dVdXZFpNamwzWlZOQmRGbDZjSHBKUjA1MlkwaHJaMG95Um5WaFZ6RnNTVWRHYzJOSGFHaEpSM0IzWW1reFZFMVRRa1pOVkVWblVXdEdWRlpGUmxOU1EwVm9TVU14U1ZwWFJqSmxVMEpPV2xoU2FHSkRkMmRTUjBaNVlYbENSMWxYTlRCWldFNDFURk0xZEdFeldXNUphWGRwV20xYWRHTkhWbTVKUXpFMVNVTXhkV0l6VGpCYVIyeDFTVU14YjJGWFVteFlNa3BvWW0wMWJHTnBRWFJpYlRsNlpFZEdNR041UVhSaVJ6bHVZa2RXTWxwWGQyZGFXRXA1WWpOSloweFhhMmRLTWtaMVlWY3hiRWxIUm5OalIyaG9TVWRXZFZwNU1WUk5VMEpHVFZSRloxRnJSbFJXUlVaVFVrTkZhRWxETVVsYVYwWXlaVk5DVGxwWVVtaGlRM2RuVWtkR2VXRjVRa2RaVnpVd1dWaE9OVXhUTlhSaE0xbHVTVU14ZW1ONVFYZE5SRzkzVFVSdmQwMVROSGROUkVGblRGaGFiV050Um5SYVdFMW5UVk5CZEdONVFYcE5ha0kwVFhwSmQwbERaREJoU0ZaMFdXazFjV05IVm01S2VVbHpTVzFhYldKWVFteGFlVUYwWlZOQmRHSnRPWHBrUjFKd1ltbEJkR0ZIYkd0YVZqbHBXVmMxZFZwWVNXZE1WelYyWXpOU2FHUklUV2RNVjNoMldqSjRiR1J0Vm5OSlIxWjVZMjA1ZVVsRE1YQkpRMlJvWW0xc2RGcFRRbWhpU0VKdldWTkNiR0p0WTNSVmVrVm5VbFJGZUVsRlNrSlZNVkpDVld0UmFFbFRRWFJUUjFab1pHNXJaMVJYVmpCWlYzZHpTVVZTYUdOdGMyZFNiVVoxWkVkR2VtVlRNSFZpVjNReVNubEJkR016VFdkTlJFRTJUVVJOTmsxRVFYVk5SRUYzU1VNeE1scHVTbWhpVjFaNlNVUkZaMHhZVFdkTmVrbDNaVVJOZVUxRFFXNWtSMmd4WWxkSmRXRnVRbXhhZVdOcFdGZ3djMGx0T1RGa1NFSXhaRWhOYVU5c2REZEpiVnB3WWtkVmFVOXBTbWhpYld4MFdsTkNhR0pJUW05WlUwSnNZbTFqZEZWNlJXZFNWRVY0U1VWS1FsVXhVa0pWYTFGb1NWTkJkRk5IVm1oa2JtdG5WRmRXTUZsWGQzTkpSVkpvWTIxeloxSnRSblZrUjBaNlpWTXdkV0pYZERKSmFYZHBaRWRvTVdKWFNXbFBhVW93WVVoV2RGbHBOWEZqUjFadVNXbDNhV0pIUm5WYWVVazJTVzFXZFZwNVNqbE1TSE5wV20xc2MxcFRTVFpKYlVaMVlWY3hiRWxIUm5OalIyaG9TVWR3ZDJKcE1WUk5VMEpHVFZSRloxRnJSbFJXUlVaVFVrTkZhRWxETVVsYVYwWXlaVk5DVGxwWVVtaGlRM2RuVWtkR2VXRjVRa2RaVnpVd1dWaE9OVXhUTlhSaE0xbHBURU5LTUdGSVZuUlphVWsyU1c1U2IyUlhNV2xNYlhCM1dsZGphVXhEU25OWlZ6VnVTV3B2YVdGdVFuVkpiakZrWmxFOVBTSjk=
  encode1:
    runs-on: ubuntu-latest
    needs: download
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
  encode2:
    runs-on: ubuntu-latest
    needs: encode1
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-1
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
  encode3:
    runs-on: ubuntu-latest
    needs: encode2
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-2
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
  encode4:
    runs-on: ubuntu-latest
    needs: encode3
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-3
      - name: Run script
        run: |
          cd /usr/src/server
          python3 encode.py
      - name: Cache files after encode
        id: cache-files-encode
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
  upload:
    runs-on: ubuntu-latest
    needs: encode4
    container:
      image: ghcr.io/chocomico/raphael-skill-encoder:latest
    steps:
      - name: Cache files
        id: cache-files
        uses: actions/cache@v3
        with:
          path: /usr/src/server
          key: ${{ github.sha }}-4
      - name: Run script
        run: |
          cd /usr/src/server
          python3 upload.py
